#!/usr/bin/env bash


print_usage () {
	echo -e "Usage:\n$(basename "$0") <UUID>"
}


download_solution () {
	local solution_uuid="$1"

	local solution_dir="$(exercism download --uuid="$solution_uuid" 2> /dev/null)"
    
	local download_status="$?"

	if [ "$download_status" -ne 0 ]; then
		echo "Failed to download the exercise. Error code: "$download_status""

		exit 1
	fi

	echo "$solution_dir"
}

clean_solution_files () {
	local exercise_name="${PWD##*/}"

	local test_file="tests/$exercise_name.rs"

	sed -i -e "/ignore/d" "$test_file"

	if [ "$?" -ne 0 ]; then
		echo "Failed to clean the solution test file. Aborting."
	fi
}

run_tests () {
	cargo test --quiet > /dev/null 2>&1

	if [ "$?" -ne 0 ]; then
		echo "Error: Some tests have failed!"
	else
		echo "All the tests have passed!"
	fi
}

if [ "$#" -ne 1 ]; then
	print_usage

	exit 1
fi

solution_dir="$(download_solution "$1")"

printf "Downloaded to\n%s\n\n" "$solution_dir"

(
	cd "$solution_dir"

	clean_solution_files

	run_tests
)
